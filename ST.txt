' COMO O FACTORY I/O ESTAVA SOBREESCREVENDO AS VARIÁVEIS, TODO ESTADO FOI REALIZADO A ATRIBUIÇÃO DESTES, AFIM DE GARANTIR O CORRETO FUNCIONAMENTO DA CENA PICK & PLACE XYZ. '

' CASO BOTÃO LIGA PRSSIONADO, LIGA SISTEMA '
IF (LIGAR = TRUE) THEN
	ESTADO_LIGADO := TRUE;
    ESTADO_DESLIGADO := FALSE;
    GRAB := FALSE;

' CASO BOTÃO DESLIGA PRESSIONADO, DESLIGA SISTEMA '
ELSIF (DESLIGAR = TRUE) THEN
	ESTADO_LIGADO := FALSE;
END_IF;

' CASO SISTEMA LIGADO, LIGA AS ESTEIRAS DAS CAIXAS E DO PALLET '
IF (ESTADO_LIGADO = TRUE) THEN

    ' ENQUANTO SENSOR DAS CAIXAS E DOS PALLETS NÃO OS IDENTIFICAREM, AS ESTEIRAS CONTINUAM LIGADAS '
    BOX_CONVEYOR := BOX_AT_PLACE OR PALLET_ESTEIRA;
    PART_CONVEYOR := PART_AT_PLACE OR CAIXAS_ESTEIRA;
  
	CASE ESTADO OF 

    0:
        ' POSICIONE O BRAÇO NA POSIÇÃO XYZ (POSIÇÃO INICIAL) '
		SP_X := 0; 
		SP_Y := 0;
		SP_Z := 0;

        ' PEGAR E ROTACIONAR DAS CAIXAS NO BRAÇO É FALSA '
		GRAB := FALSE;
		C_PLUS := FALSE;
	
        ' CASO CAIXA E PALLET FOR DETECTADO PELOS SENSORES, INICIE O 1° ESTADO '
    	IF (PART_AT_PLACE = FALSE AND BOX_AT_PLACE = FALSE) THEN
			ESTADO := 1;
		END_IF;

	1:
        ' POSICIONE O BRAÇO NA POSIÇÃO XY '
    	SP_X := 80;
		SP_Y := 55; 
		
        ' CASO BRAÇO ATINJA A POSIÇÃO XYZ, ABAIXE O BRAÇO ATÉ Z E INICIE O 2° ESTADO '
    	IF (SENSOR_X >= 75  AND SENSOR_Y >= 50 AND SENSOR_Z >= 0 AND DETECTED = FALSE AND GRAB = FALSE) THEN
			SP_Z := 50;
			ESTADO := 2;
		END_IF;

	2: 
        ' FORÇE QUE O BRAÇO PEGUE A CAIXA '
        GRAB := TRUE;
		
        ' CASO O BRAÇO ATINJA A POSIÇÃO XYZ, SUBA A CAIXA ATÉ A POSIÇÃO Z E INICIE O 3° ESTADO '
    	IF (SENSOR_X >= 75  AND SENSOR_Y >= 50 AND SENSOR_Z >= 45 AND DETECTED = TRUE AND GRAB = TRUE) THEN
			SP_Z := 25;
			ESTADO := 3;
		END_IF;
	
	3:
        ' FORÇE QUE O BRAÇO MANTENHA A CAIXA GRUDADA '
        GRAB := TRUE;

        ' CASO O BRAÇO ATINJA A POSIÇÃO XYZ, INICIE O 4° ESTADO '
      	IF (SENSOR_X >= 75  AND SENSOR_Y >= 50 AND SENSOR_Z <= 30 AND DETECTED = TRUE AND GRAB = TRUE) THEN
    		ESTADO := 4;
    	END_IF;

	4:
        ' FORÇE QUE O BRAÇO MANTENHA A CAIXA GRUDADA '
        GRAB := TRUE;
	
        ' POSICIONE O BRAÇO NA POSIÇÃO XY '
    	SP_X := 35;
      	SP_Y := 25;

		' CASO O BRAÇO ATINJA A POSIÇÃO XYZ, ABAIXE O BRAÇO ATÉ A POSIÇÃO Z E INICIE O 5° ESTADO '
    	IF (SENSOR_X <= 40 AND SENSOR_Y <= 30 AND SENSOR_Z <= 30 AND DETECTED = TRUE AND GRAB = TRUE) THEN
			SP_Z := 100;
			ESTADO := 5;
		END_IF;
	
	5:
        ' FORÇE QUE O BRAÇO MANTENHA A CAIXA GRUDADA '
		GRAB := TRUE;

        ' CASO O BRAÇO ATINJA A POSIÇÃO XYZ, DESGRUDE A CAIXA DO BRAÇO E INICIE O 6° ESTADO '
        IF (SENSOR_X <= 40 AND SENSOR_Y <= 30 AND SENSOR_Z >= 95 AND GRAB = TRUE) THEN
			GRAB := FALSE;
            ESTADO := 6;
		END_IF;

    6:
        ' FORÇE QUE O BRAÇO MANTENHA A CAIXA DESGRUDADA '
        GRAB := FALSE;
		
        ' CASO O BRAÇO ATINJA A POSIÇÃO XYZ, SUBA O BRACO ATÉ A POSIÇÃO Z, INCREMENTA O CONTADOR E INICIE O 7° ESTADO '
    	IF (SENSOR_X <= 40 AND SENSOR_Y <= 30 AND SENSOR_Z >= 95 AND GRAB = FALSE) THEN
         	SP_Z := 0;
            CONT := CONT + 1;
			ESTADO := 7;
      	END_IF;

	7:
        ' FORÇE QUE O BRAÇO MANTENHA A CAIXA DESGRUDADA '
        GRAB := FALSE;
      
        ' CASO O BRAÇO ATINJA A POSIÇÃO XYZ, INICIE O 8° CASO '
    	IF (SENSOR_X <= 40 AND SENSOR_Y <= 30 AND SENSOR_Z <= 5 AND DETECTED = FALSE AND GRAB = FALSE) THEN
		   ESTADO := 8;			
		END_IF;
		
	8:
        ' FORÇE QUE O BRAÇO MANTENHA A CAIXA DESGRUDADA '
        GRAB := FALSE;
    	
        ' POSICIONE O BRAÇO NA POSIÇÃO XY '
		SP_X := 80;
		SP_Y := 55; 
		
        ' CASO O BRAÇO ATINJA A POSIÇÃO XYZ, ABAIXE O BRAÇO ATÉ A POSIÇÃO Z, PEGUE A CAIXA E INICIE O 9° ESTADO '
    	IF (SENSOR_X >= 75  AND SENSOR_Y >= 50 AND SENSOR_Z <= 5 AND DETECTED = FALSE AND GRAB = FALSE) THEN
			SP_Z := 50;
         	GRAB := TRUE;
			ESTADO := 9;
		END_IF;
		
	9: 
        ' FORÇE QUE O BRAÇO MANTENHA A CAIXA GRUDADA '
        GRAB := TRUE;

        ' CASO O BRAÇO ESTIVER NA POSIÇÃO XYZ, SUBA A CAIXA ATÉ A POSIÇÃO Z E INICIE O 10° ESTADO '
    	IF (SENSOR_X >= 75  AND SENSOR_Y >= 50 AND SENSOR_Z >= 45 AND DETECTED = TRUE AND GRAB = TRUE) THEN
			SP_Z := 25;
			ESTADO := 10;
		END_IF;

	10:
        ' FORÇE QUE O BRAÇO MANTENHA A CAIXA GRUDADA '
        GRAB := TRUE;
    
        ' CASO O BRAÇO ESTIVER NA POSIÇÃO XYZ, INICIE O 11° ESTADO '
		IF (SENSOR_X >= 75  AND SENSOR_Y >= 50 AND SENSOR_Z <= 30 AND DETECTED = TRUE AND GRAB = TRUE) THEN
         	ESTADO := 11;
      	END_IF;
    
	11:
        ' FORÇE QUE O BRAÇO MANTENHA A CAIXA GRUDADA '
        GRAB := TRUE;
    
        ' POSICIONE O BRAÇO NA POSIÇÃO XY '
        SP_X := 35;
        SP_Y := 60;

        ' CASO O BRAÇO ESTIVER NA POSIÇÃO XYZ, ABAIXE A CAIXA ATÉ A POSIÇÃO Z E INICIE O 12° ESTADO '
      	IF (SENSOR_X <= 40 AND SENSOR_Y >= 55 AND SENSOR_Z <= 30 AND DETECTED = TRUE AND GRAB = TRUE) THEN
			SP_Z := 100;
			ESTADO := 12;
		END_IF;

	12:
        ' FORÇE QUE O BRAÇO MANTENHA A CAIXA GRUDADA '
        GRAB := TRUE;

        ' CASO A CAIXA ESTIVER NA POSIÇÃO XYZ, SOLTE A CAIXA E INICIE O 13° ESTADO '
      	IF (SENSOR_X <= 40 AND SENSOR_Y >= 55 AND SENSOR_Z >= 95 AND GRAB = TRUE) THEN
			GRAB := FALSE;
			ESTADO := 13;
      	END_IF;
    
    13:
        ' FORÇE QUE O BRAÇO MANTENHA A CAIXA DESGRUDADA '
        GRAB := FALSE;

        ' CASO O BRAÇO ESTIVER NA POSIÇÃO XYZ, SUBA A CAIXA ATÉ A POSIÇÃO Z, INCREMENTE O CONTADOR E INICIE O 14° ESTADO '
        IF (SENSOR_X <= 40 AND SENSOR_Y >= 55 AND SENSOR_Z >= 95 AND GRAB = FALSE) THEN
			SP_Z := 0;
         	CONT := CONT + 1;
			ESTADO := 14;
      	END_IF;
	
	14:
        ' FORÇE QUE O BRAÇO MANTENHA A CAIXA DESGRUDADA '
        GRAB := FALSE;
      
        ' CASO O BRAÇO ESTIVER NA POSIÇÃO XYZ, INICIE O 15° ESTADO '
        IF (SENSOR_X <= 40 AND SENSOR_Y >= 55 AND SENSOR_Z <= 5 AND DETECTED = FALSE AND GRAB = FALSE) THEN
		   ESTADO := 15;			
		END_IF;

	15:
        ' FORÇE QUE O BRAÇO MANTENHA A CAIXA DESGRUDADA '
        GRAB := FALSE;
      	
        ' POSICIONE O BRAÇO NA POSIÇÃO XY '
		SP_X := 80;
		SP_Y := 55; 
		
        ' CASO O BRAÇO ESTIVER NA POSIÇÃO XYZ, PEGUE A CAIXA E INICIE O 16° ESTADO '
    	IF (SENSOR_X >= 75 AND SENSOR_Y <= 60 AND SENSOR_Z <= 5 AND DETECTED = FALSE AND GRAB = FALSE) THEN
			SP_Z := 50;
         	GRAB := TRUE;
			ESTADO := 16;
		END_IF;

    16:
        ' FORÇE QUE O BRAÇO MANTENHA A CAIXA GRUDADA '
        GRAB := TRUE;

        ' CASO O BRAÇO ESTIVER NA POSIÇÃO XYZ, PEGUE A CAIXA E INICIE O 17° ESTADO '
        IF (SENSOR_X >= 75 AND SENSOR_Y <= 60 AND SENSOR_Z >= 45 AND DETECTED = TRUE AND GRAB = TRUE) THEN
         	GRAB := TRUE;
			ESTADO := 17;
		END_IF;

	17:
		' FORÇE QUE O BRAÇO MANTENHA A CAIXA GRUDADA '
        GRAB := TRUE;

        ' CASO O BRAÇO ESTIVER NA POSIÇÃO XYZ, SUBA O BRAÇO ATÉ A POSIÇÃO Z E INICIE O 18° ESTADO '
    	IF (SENSOR_X >= 75 AND SENSOR_Y <= 60 AND SENSOR_Z >= 45 AND DETECTED = TRUE AND GRAB = TRUE) THEN
			SP_Z := 25;
			ESTADO := 18;
		END_IF;
    
	18:
        ' FORÇE QUE O BRAÇO MANTENHA A CAIXA GRUDADA '
        GRAB := TRUE;

        ' CASO O BRAÇO ESTIVER NA POSIÇÃO XYZ, ROTACIONE A CAIXA E INICIE O 19° ESTADO '
		IF (SENSOR_X >= 75 AND SENSOR_Y <= 60 AND SENSOR_Z <= 30 AND DETECTED = TRUE AND GRAB = TRUE) THEN
         	C_PLUS := TRUE;
         	ESTADO := 19;
      	END_IF;
    
	19: 
        ' FORÇE QUE O BRAÇO MANTENHA A CAIXA GRUDADA E ROTACIONADA '
        GRAB := TRUE;
        C_PLUS := TRUE;

        ' POSICIONE O BRAÇO NA POSIÇÃO XY '
      	SP_X := 35;
      	SP_Y := 45;

        ' CASO O BRAÇO ESTIVER NA POSIÇÃO XYZ, DESÇA A CAIXA ATÉ A POSIÇÃO Z E INICIE O 20° ESTADO '
      	IF (SENSOR_X <= 40 AND SENSOR_Y <= 50 AND SENSOR_Z <= 30 AND DETECTED = TRUE AND GRAB = TRUE AND C_PLUS = TRUE) THEN
			SP_Z := 50;
			ESTADO := 20;
		END_IF;
	
	20:
        ' FORÇE QUE O BRAÇO MANTENHA A CAIXA GRUDADA E ROTACIONADA '
        GRAB := TRUE;
        C_PLUS := TRUE;

        ' CASO O BRAÇO ESTIVER NA POSIÇÃO XYZ, SOLTE A CAIXA E INICIE O 21° ESTADO '
      	IF (SENSOR_X <= 40 AND SENSOR_Y <= 50 AND SENSOR_Z >= 45 AND GRAB = TRUE AND C_PLUS = TRUE) THEN
			GRAB := FALSE;
			ESTADO := 21;
      	END_IF;
    
    21:
        ' FORÇE QUE O BRAÇO MANTENHA A CAIXA DESGRUDADA E ROTACIONADA '
        GRAB := FALSE;
        C_PLUS := TRUE;

        ' CASO O BRAÇO ESTIVER NA POSIÇÃO XYZ, SUBA O BRAÇO ATÉ A POSIÇÃO Z, INCREMENTE O CONTADOR E INICIE O 22° ESTADO '
        IF (SENSOR_X <= 40 AND SENSOR_Y <= 50 AND SENSOR_Z >= 45 AND GRAB = FALSE AND C_PLUS = TRUE) THEN
			SP_Z := 0;
         	CONT := CONT + 1;
			ESTADO := 22;
      	END_IF;
	
	22:
        ' FORÇE QUE O BRAÇO MANTENHA A CAIXA DESGRUDADA E ROTACIONADA '
        GRAB := FALSE;
        C_PLUS := TRUE;
		
        ' CASO O BRAÇO ESTIVER NA POSIÇÃO XYZ, DESROTACIONA O BRAÇO E INICIE O 23° ESTADO '
      	IF (SENSOR_X <= 40 AND SENSOR_Y <= 50 AND SENSOR_Z <= 5 AND DETECTED = FALSE AND GRAB = FALSE AND C_PLUS = TRUE) THEN
			C_PLUS := FALSE;
			ESTADO := 23;
		END_IF;
    
	23:
        ' FORÇE QUE O BRAÇO MANTENHA A CAIXA DESGRUDADA E O BRAÇO DESROTACIONADA '
        GRAB := FALSE;
        C_PLUS := FALSE;

        ' CASO TENHA UM PALLET NA FRENTE DO SENSOR, LIGUE A ESTEIRA DO PALLET CARREGADO '
      	IF (BOX_AT_PLACE = FALSE AND GRAB = FALSE AND C_PLUS = FALSE) THEN
         	BOX_CONVEYOR := TRUE;
			ESTADO := 24;
      	END_IF;
	
	24:
        ' FORÇE QUE A ESTEIRA CONTINUE LIGADA '
		BOX_CONVEYOR := TRUE;

        ' CASO NÃO HÁ UM PALLET NA FRENTE DO SENSOR, INICIE O 25° ESTADO '
		IF (BOX_AT_PLACE = TRUE AND BOX_CONVEYOR = TRUE) THEN
			ESTADO := 25;
      	END_IF;
	
	25:
        ' FORÇE QUE A ESTEIRA CONTINUE LIGADA '
		BOX_CONVEYOR := TRUE;

        ' CASO TENHA UMA CAIXA E UM PALLET NA FRENTE DOS SENSORES, PARE A ESTEIRA DAS PALLETS E VOLTE PARA O 1° ESTADO'
		IF (PART_AT_PLACE = FALSE AND BOX_AT_PLACE = FALSE) THEN
			BOX_CONVEYOR := FALSE;
			ESTADO := 1;
      	END_IF;

  	END_CASE;

' CASO SISTEMA DESLIGADO, DESLIGA AS ESTEIRAS DAS CAIXAS E DOS PALLETS ' 
ELSE
  	PART_CONVEYOR:= FALSE;
	BOX_CONVEYOR:= FALSE;
END_IF;

' CASO O BOTÃO RESET FOR PRESSIONADO, REINICIE O CONTADOR '
IF(RESET = TRUE) THEN
  CONT := 0;
END_IF;
